name: CI Pipeline

on:
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  issues: write

jobs:
  ci-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install dvc dvc-s3

    - name: Configure DVC
      run: |
        dvc remote modify --local origin url https://dagshub.com/a13x60r/dec25bmlops_int_weather.dvc
        dvc remote modify --local origin auth basic
        dvc remote modify --local origin user ${{ secrets.DAGSHUB_USERNAME }}
        dvc remote modify --local origin password ${{ secrets.DAGSHUB_TOKEN }}

    - name: Lint with Ruff
      run: |
        ruff check .
        ruff format --check .

    - name: Pull data
      run: |
        dvc pull

    - name: Test with pytest
      run: |
        pytest

    - name: Build Bento
      run: |
        bentoml build
    - name: Report Failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          try {
            const { repo, owner } = context.repo;
            const run_url = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            const issue_title = `CI Failure: ${context.workflow} on ${context.ref.replace('refs/heads/', '')}`;

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              creator: 'github-actions[bot]' // Optional: filter by bot created
            });

            const existing_issue = issues.data.find(i => i.title === issue_title);

            if (existing_issue) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing_issue.number,
                body: `Another failure occurred in run [${context.runId}](${run_url}). Check logs for details.`
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title: issue_title,
                body: `The workflow [${context.workflow}](${run_url}) failed on branch ${context.ref}.\n\nCheck the [logs](${run_url}) for details.`
              });
            }
          } catch (error) {
            console.log('Failed to create/update issue. Issues might be disabled in this repository.');
            console.log(error);
          }
