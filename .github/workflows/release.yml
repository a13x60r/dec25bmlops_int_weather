name: Release Pipeline

on:
  push:
    branches: [ "master" ]
    tags: [ 'v*.*.*' ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      issues: write
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install -e .
        pip install dvc dvc-s3 dvc-gdrive

    - name: Configure DVC
      run: |
        dvc remote modify --local origin url https://dagshub.com/a13x60r/dec25bmlops_int_weather.dvc
        dvc remote modify --local origin auth basic
        dvc remote modify --local origin user ${{ secrets.DAGSHUB_USERNAME }}
        dvc remote modify --local origin password ${{ secrets.DAGSHUB_TOKEN }}

    - name: Pull data
      run: |
        dvc pull

    - name: Run pre-commit
      run: |
        pre-commit run --all-files

    - name: Test with pytest
      run: |
        pytest

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/weather-app:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/weather-app:${{ github.sha }}
          ghcr.io/${{ github.repository_owner }}/weather-app:latest
          ghcr.io/${{ github.repository_owner }}/weather-app:${{ github.sha }}

    - name: Build and Push BentoML Service
      run: |
        # Build the Bento
        bentoml build

        # Define Tags
        DOCKER_TAG="${{ secrets.DOCKERHUB_USERNAME }}/rain-prediction-service:latest"
        GHCR_TAG="ghcr.io/${{ github.repository_owner }}/rain-prediction-service:latest"
        SHA_TAG="ghcr.io/${{ github.repository_owner }}/rain-prediction-service:${{ github.sha }}"

        # Containerize (creates local docker image)
        bentoml containerize rain_prediction_service:latest \
          --image-tag "$DOCKER_TAG" \
          --image-tag "$GHCR_TAG" \
          --image-tag "$SHA_TAG"

        # Push to Registries
        docker push "$DOCKER_TAG"
        docker push "$GHCR_TAG"
        docker push "$SHA_TAG"

    - name: Report Failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const { repo, owner } = context.repo;
          const run_url = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
          const issue_title = `Release Failure: ${context.workflow} on ${context.ref.replace('refs/heads/', '')}`;

          const issues = await github.rest.issues.listForRepo({
            owner,
            repo,
            state: 'open',
            creator: 'github-actions[bot]'
          });

          const existing_issue = issues.data.find(i => i.title === issue_title);

          if (existing_issue) {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: existing_issue.number,
              body: `Another failure occurred in run [${context.runId}](${run_url}). Check logs for details.`
            });
          } else {
            await github.rest.issues.create({
              owner,
              repo,
              title: issue_title,
              body: `The workflow [${context.workflow}](${run_url}) failed on branch ${context.ref}.\n\nCheck the [logs](${run_url}) for details.`
            });
          }
